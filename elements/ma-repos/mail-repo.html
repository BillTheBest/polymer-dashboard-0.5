<link rel="import" href="../ma-data-repo/ma-data-repo.html" />
<link rel="import" href="../ma-repos/auth-repo.html" />
<polymer-element name="mail-repo">
    <template>
        <ma-data-repo id="repo"></ma-data-repo>
        <auth-repo id="authRepo"></auth-repo>
    </template>
    <script>
        Polymer('mail-repo', {
            userSession: {},
            ready: function() {
                this.$.repo.setupContext();
                this.userSession = this.$.authRepo.session(true);
            },
            getMails: function(callback, pagination, callbackSelf) {
                var self = this;
                self.$.repo.context.db.MailUsers.include("Mail").include("User")
                        .orderBy(function(mail) {
                            return mail.Mail.SentDate
                        })
                        .filter(function(mail) {
                            mail.User__Id == this.Id && mail.IsSender == false
                        }, self.userSession).toArray(function(items) {

                            pagination.total = items.length;
                            var startElement = (pagination.page - 1) * pagination.pageSize;
                            items = items.slice(startElement, startElement + pagination.pageSize);

                            var returnItems = [];
                            for(var i in items){
                                returnItems.push(items[i].Mail);
                            }
                            console.log(returnItems);
                            self.getMailsCallback(returnItems, callback, pagination, callbackSelf)
                        });
            },
            getMailsCallback:function(returnItems, callback, pagination, callbackSelf){
                var self = this;
                var mailIds = [];
                for(var j in returnItems){
                    mailIds.push(returnItems[j].Id);
                }
                self.$.repo.context.db.MailUsers.include("User").filter(function(mail){
                    mail.Mail__Id in this > 0 && mail.IsSender == true
                },mailIds).toArray(function(senders){
                            for(var j in returnItems){
                                for(var i=0; i<= senders.length -1;i++) {
                                    if(senders[i].Mail__Id == returnItems[j].Id) {
                                        var senderName = senders[i].User.Email;
                                        returnItems[j].Sender = senderName;
                                        break;
                                    }
                                }
                            }
                            callback((returnItems), pagination.total, callbackSelf);
                        }
                );
            }
        });
    </script>
</polymer-element>