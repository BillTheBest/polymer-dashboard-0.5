<link rel="import" href="../../elements/ma-box/ma-box.html"/>
<link rel="import" href="../../elements/ma-repos/task-repo.html">
<link rel="import" href="../../elements/ma-list/ma-list.html">
<link rel="import" href="../../pages/tasks/task-list-item.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../elements/ma-repos/mail-repo.html">
<link rel="import" href="mail-item.html">

<polymer-element name="ma-page-mails">
    <template>
        <link rel="stylesheet" href="mails.css">
        <mail-repo id="repo"></mail-repo>
        <ma-list id="maList" list="{{list}}">
            <template repeat="{{item in list}}">
                <mail-item id="maItem{{item.Id}}"></mail-item>
            </template>
        </ma-list>
        <mail-popup id="mailPopup"></mail-popup>
        <paper-fab icon="add" role="button" class="fabBtn" on-tap="{{newItem}}"></paper-fab>
    </template>
    <script>
        Polymer('ma-page-mails', {
            list: [],
            player: {},
            ready: function () {
                var self = this;
                self.$.maList.pagination.page = 1;
                self.$.maList.addEventListener("page-changed", function () {
                    self.loadList();
                });
                self.$.maList.addEventListener("reset-list-selected", function () {
                    self.resetListSelected();
                });
                this.loadList();
            },
            listChanged: function () {
                var self = this;
                self.async(function () {
                    for (var i in self.list) {
                        var element = self.$.maList;
                        for (var j in self.$.maList.childNodes) {
                            if (self.$.maList.childNodes[j].id == "maItem" + self.list[i].Id) {
                                self.$.maList.childNodes[j].item = self.list[i];
                            }
                        }
                    }
                }, null, 0);
            },
            resetListSelected: function () {
                for (var i in this.list) {
                    this.list[i].selected = false;
                }
            },
            resetList: function () {
                this.$.maList.pagination.page = 1;
                this.$.loadList();
            },
            newItem: function () {
                this.$.mailPopup.newItem();
            },
            loadList: function () {
                this.$.repo.getMails(this.mailListCallback, this.$.maList.pagination, this);
            },
            mailListCallback: function (list, total, self) {
                self.$.maList.pagination.total = total;
                self.list = [];
                for (var key in list) {
                    self.list.push({
                        Id: list[key].Id,
                        IsSelected: false,
                        Title: list[key].Title,
                        Message: list[key].Message,
                        SentDate: list[key].SentDate,
                        Sender: list[key].Sender
                    });
                }
            }
        });
    </script>
</polymer-element>